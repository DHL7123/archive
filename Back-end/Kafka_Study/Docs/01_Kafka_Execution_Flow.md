# Kafka Execution Flow

## Kafka란?

이전 문서에서 간단히 다뤘던 내용을 보완하여, Kafka의 핵심 개념과 동작 원리를 공식 문서를 참고해 더 깊이 다룹니다.

---

### 1. Kafka는 ‘분산 이벤트 스트리밍 플랫폼’이다.

#### 1-1. Event Streaming이란?
이벤트 스트리밍은 실시간으로 **이벤트 소스**에서 발생하는 데이터를 캡처하고, 이를 저장 및 처리하여 필요한 곳에 전달하는 기술입니다.

- **Event Source**: 이벤트가 발생하는 곳 (예: 데이터베이스, 소프트웨어 애플리케이션, 모바일 디바이스 등)
- **효과**:
  - 실시간 데이터 흐름 보장
  - 데이터 분석 및 처리 구조 제공
  - 처리 지연 없이 적절한 시점에 데이터 전달

#### 1-2. Event Stream이란?
- **Event**: 어떤 일이 발생했다는 사실 (예: 회원 탈퇴, 주문 취소, 로그인 성공 등)
- **Stream**: 시간에 따라 연속적으로 발생하는 데이터의 흐름

따라서, **Event Stream**은 연속적으로 발생하는 이벤트의 흐름을 의미합니다.

#### 1-3. Kafka의 Event Streaming Platform
Kafka는 다음과 같은 3가지 핵심 개념을 통해 Event Streaming Platform을 구성합니다:
1. Event Stream을 **Publish/Subscribe**한다. (Pub/Sub 구조)
2. Event Stream을 안전하게 저장한다.
3. 실시간 및 과거의 Event Stream을 처리한다. (실시간 처리, 재처리)

---

## Kafka의 기본 구조

![Kafka Architecture](https://miro.medium.com/v2/resize:fit:720/format:webp/1*qH6bx8wESbc4IyrGWIZdkg.png)

- **Kafka 클러스터**: 메시지를 저장하는 저장소
- **브로커**: 메시지를 나눠 저장하는 서버
- **주키퍼**: 클러스터 관리
- **프로듀서**: 메시지를 Kafka 클러스터에 전송
- **컨슈머**: Kafka에서 메시지를 읽음
- **토픽**: 메시지를 구분하는 단위 (파일 시스템의 폴더와 유사)
  - 한 개의 토픽은 하나 이상의 **파티션**으로 구성
- **파티션**: 메시지를 저장하는 물리적 파일 (Append-only 구조)
  - **오프셋**: 각 메시지의 저장 위치
  - 프로듀서가 추가한 메시지는 파티션 맨 뒤에 추가
  - 컨슈머는 오프셋 기준으로 메시지를 순서대로 읽음 (파티션 내에서만 순서 보장)

### 파티션과 메시지 처리
- **프로듀서**:
  - 라운드로빈 방식 또는 키를 기준으로 파티션 선택
  - 같은 키를 가진 메시지는 같은 파티션에 저장 → 순서 유지
- **컨슈머**:
  - 컨슈머는 **컨슈머 그룹**에 속함
  - 한 파티션은 컨슈머 그룹 내 하나의 컨슈머만 연결 가능
  - 컨슈머 그룹 기준으로 파티션의 메시지는 순서대로 처리

---

## 성능 최적화

### 1. 파일 I/O 최적화
- 파티션 파일은 OS의 **페이지 캐시**를 사용
- 파일 I/O가 메모리에서 처리되므로 성능이 향상
- 서버에서 페이지 캐시를 Kafka 전용으로 사용하는 것이 유리

### 2. Zero-Copy
- 디스크 버퍼에서 네트워크 버퍼로 데이터를 직접 복사하여 성능 최적화

### 3. 브로커의 단순화
- 브로커는 컨슈머 추적 및 파티션-컨슈머 매핑 관리만 수행
- 메시지 필터링, 재전송 등은 프로듀서와 컨슈머가 직접 처리

### 4. Batch 처리
- **프로듀서**: 일정 크기만큼 메시지를 모아서 전송
- **컨슈머**: 일정 크기만큼 메시지를 모아서 조회
- 낱개 처리보다 처리량 증가

### 5. 확장성
- **브로커 추가**: 장비 용량 한계 시 브로커와 파티션 추가
- **컨슈머 추가**: 처리 속도가 느릴 경우 컨슈머와 파티션 추가
- 수평적 확장이 용이

---

## 리플리카와 장애 대응

### 리플리카 (복제)
- **리플리카**: 파티션의 복제본
- 복제본은 각 브로커에 생성됨
- **리더와 팔로워**:
  - 프로듀서와 컨슈머는 리더를 통해서만 메시지 처리
  - 팔로워는 리더로부터 복제

### 장애 대응
- 리더가 속한 브로커가 장애 발생 시, 팔로워 중 하나가 리더로 승격

---

## 참고 자료
- [Kafka 공식문서](https://kafka.apache.org/documentation/)
- [Medium](https://medium.com/@cobch7/kafka-architecture-43333849e0f4)